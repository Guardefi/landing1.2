# Justfile for Scorpius DeFi Security Platform
# Usage: just <command>

# Set shell for commands
set shell := ["bash", "-c"]

# Default command - show help
default:
    @just --list

# Development commands
# ===================

# Start full development environment
dev:
    #!/bin/bash
    echo "ü¶Ç Starting Scorpius development environment..."

    # Check if Docker is running
    if ! docker info >/dev/null 2>&1; then
        echo "‚ùå Docker is not running. Please start Docker first."
        exit 1
    fi

    # Start backend services (PostgreSQL, Redis)
    echo "üì¶ Starting database services..."
    docker-compose up -d postgres redis

    # Wait for database to be ready
    echo "‚è≥ Waiting for database to be ready..."
    sleep 5

    # Install dependencies if needed
    if [ ! -d "node_modules" ]; then
        echo "üì• Installing frontend dependencies..."
        npm install --legacy-peer-deps
    fi

    # Start frontend development server
    echo "üöÄ Starting frontend development server..."
    npm run dev &
    FRONTEND_PID=$!

    # Start backend development server (if exists)
    if [ -f "backend/main.py" ]; then
        echo "üêç Starting backend development server..."
        cd backend
        if [ ! -d ".venv" ]; then
            python -m venv .venv
            source .venv/bin/activate
            pip install -r requirements.txt
        else
            source .venv/bin/activate
        fi
        uvicorn main:app --reload --host 0.0.0.0 --port 8000 &
        BACKEND_PID=$!
        cd ..
    fi

    echo "‚úÖ Development environment started!"
    echo "üì± Frontend: http://localhost:8080"
    echo "üîó Backend API: http://localhost:8000"
    echo "üìä API Docs: http://localhost:8000/docs"
    echo ""
    echo "Press Ctrl+C to stop all services"

    # Trap Ctrl+C to cleanup processes
    trap 'echo "üõë Stopping services..."; kill $FRONTEND_PID $BACKEND_PID 2>/dev/null; docker-compose down; exit 0' INT

    # Wait for processes
    wait

# Start minimal development environment (frontend only)
dev-minimal:
    #!/bin/bash
    echo "ü¶Ç Starting minimal Scorpius development..."

    if [ ! -d "node_modules" ]; then
        echo "üì• Installing dependencies..."
        npm install --legacy-peer-deps
    fi

    echo "üöÄ Starting frontend only..."
    npm run dev

# Install all dependencies
install:
    #!/bin/bash
    echo "üì• Installing all dependencies..."

    # Frontend dependencies
    echo "üé® Installing frontend dependencies..."
    npm install --legacy-peer-deps

    # Backend dependencies (if requirements.txt exists)
    if [ -f "backend/requirements.txt" ]; then
        echo "üêç Installing backend dependencies..."
        cd backend
        if [ ! -d ".venv" ]; then
            python -m venv .venv
        fi
        source .venv/bin/activate
        pip install -r requirements.txt
        cd ..
    fi

    echo "‚úÖ All dependencies installed!"

# Quality commands
# ================

# Run all tests
test:
    #!/bin/bash
    echo "üß™ Running all tests..."

    # Frontend tests
    echo "üé® Running frontend tests..."
    npm run test

    # Backend tests (if pytest is available)
    if [ -f "backend/requirements.txt" ] && command -v pytest >/dev/null; then
        echo "üêç Running backend tests..."
        cd backend
        if [ -d ".venv" ]; then
            source .venv/bin/activate
        fi
        pytest --cov=. --cov-report=term-missing --cov-fail-under=20
        cd ..
    fi

    echo "‚úÖ All tests completed!"

# Run only frontend tests
test-frontend:
    @echo "üé® Running frontend tests..."
    npm run test

# Run frontend tests with coverage
test-coverage:
    @echo "üìä Running frontend tests with coverage..."
    npm run test:coverage

# Run backend tests
test-backend:
    #!/bin/bash
    echo "üêç Running backend tests..."
    cd backend
    if [ -d ".venv" ]; then
        source .venv/bin/activate
    fi
    pytest --cov=. --cov-report=term-missing --cov-fail-under=20

# Lint all code
lint:
    #!/bin/bash
    echo "üîç Linting all code..."

    # Frontend linting
    echo "üé® Linting frontend code..."
    npm run lint
    npm run typecheck

    # Backend linting
    if [ -f "backend/requirements.txt" ]; then
        echo "üêç Linting backend code..."
        cd backend
        if [ -d ".venv" ]; then
            source .venv/bin/activate
        fi

        # Run ruff (if available)
        if command -v ruff >/dev/null; then
            ruff check .
            ruff format --check .
        fi

        # Run black (if available)
        if command -v black >/dev/null; then
            black --check .
        fi

        # Run isort (if available)
        if command -v isort >/dev/null; then
            isort --check --diff .
        fi

        cd ..
    fi

    echo "‚úÖ Linting completed!"

# Fix linting issues
lint-fix:
    #!/bin/bash
    echo "üîß Fixing linting issues..."

    # Frontend
    echo "üé® Fixing frontend linting issues..."
    npm run lint:fix || echo "Frontend lint fix completed with warnings"

    # Backend
    if [ -f "backend/requirements.txt" ]; then
        echo "üêç Fixing backend linting issues..."
        cd backend
        if [ -d ".venv" ]; then
            source .venv/bin/activate
        fi

        if command -v ruff >/dev/null; then
            ruff check --fix .
            ruff format .
        fi

        if command -v black >/dev/null; then
            black .
        fi

        if command -v isort >/dev/null; then
            isort .
        fi

        cd ..
    fi

    echo "‚úÖ Linting fixes applied!"

# Format all code
format:
    #!/bin/bash
    echo "‚ú® Formatting all code..."

    # Frontend
    npm run format

    # Backend
    if [ -f "backend/requirements.txt" ]; then
        cd backend
        if [ -d ".venv" ]; then
            source .venv/bin/activate
        fi

        if command -v black >/dev/null; then
            black .
        fi

        if command -v isort >/dev/null; then
            isort .
        fi

        cd ..
    fi

    echo "‚úÖ Code formatting completed!"

# Database commands
# =================

# Reset database to clean state
reset-db:
    #!/bin/bash
    echo "üóÑÔ∏è Resetting database..."

    # Stop any running database
    docker-compose down postgres

    # Remove database volume
    docker volume rm $(docker-compose config --services | grep postgres | head -1)_postgres_data 2>/dev/null || true

    # Start fresh database
    docker-compose up -d postgres

    # Wait for startup
    echo "‚è≥ Waiting for database to start..."
    sleep 5

    # Run migrations if they exist
    if [ -f "backend/alembic.ini" ]; then
        echo "üîÑ Running database migrations..."
        cd backend
        if [ -d ".venv" ]; then
            source .venv/bin/activate
        fi
        alembic upgrade head
        cd ..
    fi

    echo "‚úÖ Database reset completed!"

# Seed database with test data
seed:
    #!/bin/bash
    echo "üå± Seeding database with test data..."

    cd backend
    if [ -d ".venv" ]; then
        source .venv/bin/activate
    fi

    # Run seeder script if it exists
    if [ -f "seed_data.py" ]; then
        python seed_data.py
    elif [ -f "scripts/seed.py" ]; then
        python scripts/seed.py
    else
        echo "‚ö†Ô∏è No seed script found (seed_data.py or scripts/seed.py)"
    fi

    cd ..
    echo "‚úÖ Database seeding completed!"

# Database management commands
# ============================

# Reset database (WARNING: destroys all data)
reset-db:
    #!/bin/bash
    echo "üîÑ Resetting database..."
    echo "‚ö†Ô∏è  WARNING: This will destroy all data!"
    read -p "Are you sure? (y/N): " confirm
    if [[ $confirm == [yY] || $confirm == [yY][eE][sS] ]]; then
        echo "üóëÔ∏è  Stopping database..."
        docker-compose down postgres
        echo "üßπ Removing database volume..."
        docker volume rm newscorpiusm_postgres_data 2>/dev/null || true
        echo "üöÄ Starting fresh database..."
        docker-compose up -d postgres
        echo "‚è≥ Waiting for database to be ready..."
        sleep 10
        echo "‚úÖ Database reset complete!"
    else
        echo "‚ùå Database reset cancelled"
    fi

# Run database migrations
migrate:
    #!/bin/bash
    echo "üîÑ Running database migrations..."
    cd backend
    if [ -d ".venv" ]; then
        source .venv/bin/activate
    fi
    
    # Run Alembic migrations if available
    if [ -f "alembic.ini" ]; then
        alembic upgrade head
    else
        echo "‚ö†Ô∏è  No migrations found (alembic.ini not present)"
    fi
    cd ..
    echo "‚úÖ Migrations completed!"

# Seed database with test data
seed:
    #!/bin/bash
    echo "üå± Seeding database with test data..."
    cd backend
    if [ -d ".venv" ]; then
        source .venv/bin/activate
    fi
    
    # Run seed script if available
    if [ -f "seed_data.py" ]; then
        python seed_data.py
    elif [ -f "scripts/seed.py" ]; then
        python scripts/seed.py
    else
        echo "‚ö†Ô∏è  No seed script found"
        echo "üí° You can create backend/seed_data.py for test data"
    fi
    cd ..
    echo "‚úÖ Database seeded!"

# Docker Compose management
# =========================

# Start all services with Docker Compose
compose:
    @echo "üê≥ Starting all services with Docker Compose..."
    docker-compose up -d

# Stop all services
compose-down:
    @echo "üõë Stopping all services..."
    docker-compose down

# View service logs
logs:
    @echo "üìã Viewing service logs..."
    docker-compose logs -f

# Check service status
status:
    @echo "üìä Checking service status..."
    docker-compose ps

# Start only database services
services:
    @echo "üíæ Starting database services..."
    docker-compose up -d postgres redis

# Build Docker images
build:
    @echo "üî® Building Docker images..."
    docker-compose build

# Clean Docker resources
clean-docker:
    #!/bin/bash
    echo "üßπ Cleaning Docker resources..."
    echo "‚ö†Ô∏è  This will remove unused containers, networks, and images"
    read -p "Continue? (y/N): " confirm
    if [[ $confirm == [yY] || $confirm == [yY][eE][sS] ]]; then
        docker-compose down -v
        docker system prune -f
        echo "‚úÖ Docker cleanup complete!"
    else
        echo "‚ùå Docker cleanup cancelled"
    fi

# Security and maintenance commands
# =================================

# Run security audit
security-audit:
    #!/bin/bash
    echo "üîí Running security audit..."
    
    # Frontend security audit
    echo "üé® Auditing frontend dependencies..."
    npm audit || echo "Frontend audit completed with warnings"
    
    # Backend security audit
    if command -v safety >/dev/null 2>&1; then
        echo "üêç Auditing backend dependencies..."
        cd backend
        if [ -d ".venv" ]; then
            source .venv/bin/activate
        fi
        safety check || echo "Backend audit completed with warnings"
        cd ..
    fi
    
    # Secret scanning
    if command -v gitleaks >/dev/null 2>&1; then
        echo "üîç Scanning for secrets..."
        gitleaks detect --config .gitleaks.toml --no-banner
    fi
    
    echo "‚úÖ Security audit complete!"

# Run all quality checks
check:
    @echo "‚úÖ Running all quality checks..."
    @just lint
    @just test
    @just security-audit

# Setup pre-commit hooks
setup-hooks:
    #!/bin/bash
    echo "ü™ù Setting up pre-commit hooks..."
    if command -v pre-commit >/dev/null 2>&1; then
        pre-commit install
        echo "‚úÖ Pre-commit hooks installed!"
    else
        echo "‚ö†Ô∏è  pre-commit not found. Install with: pip install pre-commit"
    fi

# Show development environment info
info:
    #!/bin/bash
    echo "üìã Scorpius Development Environment Info"
    echo "========================================"
    echo ""
    echo "üê≥ Docker:"
    docker --version 2>/dev/null || echo "  ‚ùå Docker not installed"
    docker-compose --version 2>/dev/null || echo "  ‚ùå Docker Compose not installed"
    echo ""
    echo "üì¶ Node.js:"
    node --version 2>/dev/null || echo "  ‚ùå Node.js not installed"
    npm --version 2>/dev/null || echo "  ‚ùå npm not installed"
    echo ""
    echo "üêç Python:"
    python --version 2>/dev/null || python3 --version 2>/dev/null || echo "  ‚ùå Python not installed"
    echo ""
    echo "üîß Tools:"
    just --version 2>/dev/null || echo "  ‚ùå just not installed"
    git --version 2>/dev/null || echo "  ‚ùå git not installed"
    gitleaks version 2>/dev/null || echo "  ‚ùå gitleaks not installed"
    echo ""
    echo "üìä Services:"
    if command -v docker >/dev/null 2>&1; then
        docker-compose ps 2>/dev/null || echo "  No services running"
    fi
    echo ""
    echo "üåê URLs:"
    echo "  Frontend: http://localhost:8080"
    echo "  Backend API: http://localhost:8000"
    echo "  API Docs: http://localhost:8000/docs"
```

"""
Test suite for the comparison engine component.
"""

import pytest
from core.comparison_engine import BytecodeComparisonEngine


class TestBytecodeComparisonEngine:
    """Test cases for the BytecodeComparisonEngine class."""
    
    @pytest.fixture
    def engine(self):
        """Create a comparison engine instance for testing."""
        config = {
            'jaccard_threshold': 0.8,
            'ngram_size': 4,
            'structural_weight': 0.3,
            'use_weighted_jaccard': True
        }
        return BytecodeComparisonEngine(config)
    
    @pytest.fixture
    def test_bytecodes(self):
        """Sample bytecodes for testing."""
        return {
            'identical': ("60016002", "60016002"),
            'similar': ("60016002600381", "60016002600381"),
            'different': ("60016002", "60056006"),
            'empty': ("", ""),
            'one_empty': ("60016002", ""),
            'complex1': "608060405234801561001057600080fd5b50600436106100b95760003560e01c806370a08231",
            'complex2': "608060405234801561001057600080fd5b50600436106100b95760003560e01c806370a08232"
        }
    
    def test_engine_initialization(self, engine):
        """Test that the engine initializes correctly."""
        assert engine is not None
        assert engine.config['jaccard_threshold'] == 0.8
        assert engine.config['ngram_size'] == 4
    
    def test_jaccard_similarity_identical(self, engine, test_bytecodes):
        """Test Jaccard similarity with identical bytecodes."""
        bytecode1, bytecode2 = test_bytecodes['identical']
        
        similarity = engine.jaccard_similarity(bytecode1, bytecode2)
        
        assert similarity == 1.0
    
    def test_jaccard_similarity_different(self, engine, test_bytecodes):
        """Test Jaccard similarity with different bytecodes."""
        bytecode1, bytecode2 = test_bytecodes['different']
        
        similarity = engine.jaccard_similarity(bytecode1, bytecode2)
        
        assert 0.0 <= similarity <= 1.0
        assert similarity < 1.0  # Should not be identical
    
    def test_jaccard_similarity_empty(self, engine, test_bytecodes):
        """Test Jaccard similarity with empty bytecodes."""
        empty_pair = test_bytecodes['empty']
        one_empty_pair = test_bytecodes['one_empty']
        
        # Both empty should have similarity 1.0 or special handling
        empty_similarity = engine.jaccard_similarity(*empty_pair)
        assert 0.0 <= empty_similarity <= 1.0
        
        # One empty should have low similarity
        one_empty_similarity = engine.jaccard_similarity(*one_empty_pair)
        assert 0.0 <= one_empty_similarity <= 1.0
        assert one_empty_similarity < 0.5
    
    def test_ngram_similarity(self, engine, test_bytecodes):
        """Test n-gram similarity computation."""
        bytecode1, bytecode2 = test_bytecodes['similar']
        
        similarity = engine.ngram_similarity(bytecode1, bytecode2)
        
        assert 0.0 <= similarity <= 1.0
        
        # Test with different n-gram sizes
        for n in [2, 3, 4, 5]:
            engine.config['ngram_size'] = n
            sim = engine.ngram_similarity(bytecode1, bytecode2)
            assert 0.0 <= sim <= 1.0
    
    def test_structural_similarity(self, engine, test_bytecodes):
        """Test structural similarity computation."""
        bytecode1 = test_bytecodes['complex1']
        bytecode2 = test_bytecodes['complex2']
        
        similarity = engine.structural_similarity(bytecode1, bytecode2)
        
        assert 0.0 <= similarity <= 1.0
    
    def test_opcode_frequency_similarity(self, engine):
        """Test opcode frequency-based similarity."""
        # Two bytecodes with similar opcode distributions
        bytecode1 = "60016002810181905560056006810181905560076008"
        bytecode2 = "60016002810181905560096010810181905560116012"
        
        similarity = engine.opcode_frequency_similarity(bytecode1, bytecode2)
        
        assert 0.0 <= similarity <= 1.0
        assert similarity > 0.5  # Should be somewhat similar
    
    def test_sequence_similarity(self, engine):
        """Test sequence-based similarity."""
        # Similar instruction sequences
        bytecode1 = "60016002810181905560056006810181905560076008"
        bytecode2 = "60016002810181905560056006810181905560096010"
        
        similarity = engine.sequence_similarity(bytecode1, bytecode2)
        
        assert 0.0 <= similarity <= 1.0
    
    def test_weighted_jaccard_similarity(self, engine):
        """Test weighted Jaccard similarity."""
        bytecode1 = "60016002810181905560056006810181905560076008"
        bytecode2 = "60016002810181905560056006810181905560096010"
        
        # Test with weights enabled
        engine.config['use_weighted_jaccard'] = True
        weighted_sim = engine.jaccard_similarity(bytecode1, bytecode2)
        
        # Test with weights disabled
        engine.config['use_weighted_jaccard'] = False
        unweighted_sim = engine.jaccard_similarity(bytecode1, bytecode2)
        
        assert 0.0 <= weighted_sim <= 1.0
        assert 0.0 <= unweighted_sim <= 1.0
        
        # Results might be different depending on instruction importance
        # but both should be valid
    
    def test_multi_dimensional_comparison(self, engine, test_bytecodes):
        """Test multi-dimensional comparison."""
        bytecode1 = test_bytecodes['complex1']
        bytecode2 = test_bytecodes['complex2']
        
        result = engine.multi_dimensional_compare(bytecode1, bytecode2)
        
        assert isinstance(result, dict)
        assert 'jaccard_similarity' in result
        assert 'ngram_similarity' in result  
        assert 'structural_similarity' in result
        assert 'opcode_frequency_similarity' in result
        assert 'overall_similarity' in result
        
        # All similarities should be in valid range
        for key, value in result.items():
            if 'similarity' in key:
                assert 0.0 <= value <= 1.0
    
    def test_batch_comparison(self, engine, test_bytecodes):
        """Test batch comparison functionality."""
        pairs = [
            test_bytecodes['identical'],
            test_bytecodes['similar'],
            test_bytecodes['different']
        ]
        
        results = engine.batch_compare(pairs)
        
        assert len(results) == len(pairs)
        for result in results:
            assert isinstance(result, dict)
            assert 'overall_similarity' in result
            assert 0.0 <= result['overall_similarity'] <= 1.0
    
    def test_similarity_caching(self, engine):
        """Test that similarity results are cached for performance."""
        bytecode1 = "60016002810181905560056006810181905560076008"
        bytecode2 = "60016002810181905560056006810181905560096010"
        
        # First computation
        result1 = engine.multi_dimensional_compare(bytecode1, bytecode2)
        
        # Second computation (should use cache if implemented)
        result2 = engine.multi_dimensional_compare(bytecode1, bytecode2)
        
        # Results should be identical
        assert result1['overall_similarity'] == result2['overall_similarity']
        
        # If caching is implemented, second call should be faster
        # This is hard to test reliably, but results should be identical
    
    def test_threshold_application(self, engine):
        """Test threshold application in similarity decisions."""
        # Test with high similarity (should exceed threshold)
        bytecode1 = "60016002810181905560056006"
        bytecode2 = "60016002810181905560056006"
        
        result_high = engine.multi_dimensional_compare(bytecode1, bytecode2)
        
        # Test with low similarity (should not exceed threshold)
        bytecode3 = "60016002810181905560056006"
        bytecode4 = "60ff60fe60fd60fc60fb60fa"
        
        result_low = engine.multi_dimensional_compare(bytecode3, bytecode4)
        
        # Check threshold application
        threshold = engine.config.get('jaccard_threshold', 0.8)
        
        if 'exceeds_threshold' in result_high:
            expected_high = result_high['overall_similarity'] >= threshold
            assert result_high['exceeds_threshold'] == expected_high
        
        if 'exceeds_threshold' in result_low:
            expected_low = result_low['overall_similarity'] >= threshold
            assert result_low['exceeds_threshold'] == expected_low
    
    def test_normalization_integration(self, engine):
        """Test integration with bytecode normalization."""
        # Test with metadata and constants that should be normalized
        bytecode1 = "608060405234801561001057600080fda165627a7a72305820"
        bytecode2 = "608060405234801561001057600080fda165627a7a72305821"
        
        # Should normalize before comparison
        result = engine.multi_dimensional_compare(bytecode1, bytecode2)
        
        # Should be highly similar after normalization (metadata removed)
        assert result['overall_similarity'] > 0.8
    
    def test_instruction_importance_weighting(self, engine):
        """Test that different instructions have appropriate importance weights."""
        # Test with different types of instructions
        storage_heavy = "60015560025560035560045560055560065560075560085560095560105560115560125560135560145560155560165560175560185560195560205560215560225560235560245560255560265560275560285560295560305560315560325560335560345560355560365560375560385560395560405560415560425560435560445560455560465560475560485560495560505560515560525560535560545560555560565560575560585560595560605560615560625560635560645560655560665560675560685560695560705560715560725560735560745560755560765560775560785560795560805560815560825560835560845560855560865560875560885560895560905560915560925560935560945560955560965560975560985560995561005561015561025561035561045561055561065561075561085561095561105561115561125561135561145561155561165561175561185561195561205561215561225561235561245561255561265561275561285561295561305561315561325561335561345561355561365561375561385561395561405561415561425561435561445561455561465561475561485561495561505561515561525561535561545561555561565561575561585561595561605561615561625561635561645561655561665561675561685561695561705561715561725561735561745561755561765561775561785561795561805561815561825561835561845561855561865561875561885561895561905561915561925561935561945561955561965561975561985561995562005562015562025562035562045562055562065562075562085562095562105562115562125562135562145562155562165562175562185562195562205562215562225562235562245562255562265562275562285562295562305562315562325562335562345562355562365562375562385562395562405562415562425562435562445562455562465562475562485562495562505562515562525562535562545562555562565562575562585562595562605562615562625562635562645562655562665562675562685562695562705562715562725562735562745562755562765562775562785562795562805562815562825562835562845562855562865562875562885562895562905562915562925562935562945562955562965562975562985562995563005563015563025563035563045563055563065563075563085563095563105563115563125563135563145563155563165563175563185563195563205563215563225563235563245563255563265563275563285563295563305563315563325563335563345563355563365563375563385563395563405563415563425563435563445563455563465563475563485563495563505563515563525563535563545563555563565563575563585563595563605563615563625563635563645563655563665563675563685563695563705563715563725563735563745563755563765563775563785563795563805563815563825563835563845563855563865563875563885563895563905563915563925563935563945563955563965563975563985563995564005564015564025564035564045564055564065564075564085564095564105564115564125564135564145564155564165564175564185564195564205564215564225564235564245564255564265564275564285564295564305564315564325564335564345564355564365564375564385564395564405564415564425564435564445564455564465564475564485564495564505564515564525564535564545564555564565564575564585564595564605564615564625564635564645564655564665564675564685564695564705564715564725564735564745564755564765564775564785564795564805564815564825564835564845564855564865564875564885564895564905564915564925564935564945564955564965564975564985564995565005565015565025565035565045565055565065565075565085565095565105565115565125565135565145565155565165565175565185565195565205565215565225565235565245565255565265565275565285565295565305565315565325565335565345565355565365565375565385565395565405565415565425565435565445565455565465565475565485565495565505565515565525565535565545565555565565575565585565595565605565615565625565635565645565655565665565675565685565695565705565715565725565735565745565755565765565775565785565795565805565815565825565835565845565855565865565875565885565895565905565915565925565935565945565955565965565975565985565995566005566015566025566035566045566055566065566075566085566095566105566115566125566135566145566155566165566175566185566195566205566215566225566235566245566255566265566275566285566295566305566315566325566335566345566355566365566375566385566395566405566415566425566435566445566455566465566475566485566495566505566515566525566535566545566555566565566575566585566595566605566615566625566635566645566655566665566675566685566695566705566715566725566735566745566755566765566775566785566795566805566815566825566835566845566855566865566875566885566895566905566915566925566935566945566955566965566975566985566995567005567015567025567035567045567055567065567075567085567095567105567115567125567135567145567155567165567175567185567195567205567215567225567235567245567255567265567275567285567295567305567315567325567335567345567355567365567375567385567395567405567415567425567435567445567455567465567475567485567495567505567515567525567535567545567555567565567575567585567595567605567615567625567635567645567655567665567675567685567695567705567715567725567735567745567755567765567775567785567795567805567815567825567835567845567855567865567875567885567895567905567915567925567935567945567955567965567975567985567995568005568015568025568035568045568055568065568075568085568095568105568115568125568135568145568155568165568175568185568195568205568215568225568235568245568255568265568275568285568295568305568315568325568335568345568355568365568375568385568395568405568415568425568435568445568455568465568475568485568495568505568515568525568535568545568555568565568575568585568595568605568615568625568635568645568655568665568675568685568695568705568715568725568735568745568755568765568775568785568795568805568815568825568835568845568855568865568875568885568895568905568915568925568935568945568955568965568975568985568995569005569015569025569035569045569055569065569075569085569095569105569115569125569135569145569155569165569175569185569195569205569215569225569235569245569255569265569275569285569295569305569315569325569335569345569355569365569375569385569395569405569415569425569435569445569455569465569475569485569495569505569515569525569535569545569555569565569575569585569595569605569615569625569635569645569655569665569675569685569695569705569715569725569735569745569755569765569775569785569795569805569815569825569835569845569855569865569875569885569895569905569915569925569935569945569955569965569975569985569995570005570015570025570035570045570055570065570075570085570095570105570115570125570135570"
        arithmetic_heavy = "60016002010360046005010360076008010360096010010360116012010360136014010360156016010360176018010360196020010360216022010360236024010360256026010360276028010360296030010360316032010360336034010360356036010360376038010360396040010360416042010360436044010360456046010360476048010360496050010360516052010360536054010360556056010360576058010360596060010360616062010360636064010360656066010360676068010360696070010360716072010360736074010360756076010360776078010360796080010360816082010360836084010360856086010360876088010360896090010360916092010360936094010360956096010360976098010360996100010361016102010361036104010361056106010361076108010361096110010361116112010361136114010361156116010361176118010361196120010361216122010361236124010361256126010361276128010361296130010361316132010361336134010361356136010361376138010361396140010361416142010361436144010361456146010361476148010361496150010361516152010361536154010361556156010361576158010361596160010361616162010361636164010361656166010361676168010361696170010361716172010361736174010361756176010361776178010361796180010361816182010361836184010361856186010361876188010361896190010361916192010361936194010361956196010361976198010361996200010362016202010362036204010362056206010362076208010362096210010362116212010362136214010362156216010362176218010362196220010362216222010362236224010362256226010362276228010362296230010362316232010362336234010362356236010362376238010362396240010362416242010362436244010362456246010362476248010362496250010362516252010362536254010362556256010362576258010362596260010362616262010362636264010362656266010362676268010362696270010362716272010362736274010362756276010362776278010362796280010362816282010362836284010362856286010362876288010362896290010362916292010362936294010362956296010362976298010362996300010363016302010363036304010363056306010363076308010363096310010363116312010363136314010363156316010363176318010363196320010363216322010363236324010363256326010363276328010363296330010363316332010363336334010363356336010363376338010363396340010363416342010363436344010363456346010363476348010363496350010363516352010363536354010363556356010363576358010363596360010363616362010363636364010363656366010363676368010363696370010363716372010363736374010363756376010363776378010363796380010363816382010363836384010363856386010363876388010363896390010363916392010363936394010363956396010363976398010363996400010364016402010364036404010364056406010364076408010364096410010364116412010364136414010364156416010364176418010364196420010364216422010364236424010364256426010364276428010364296430010364316432010364336434010364356436010364376438010364396440010364416442010364436444010364456446010364476448010364496450010364516452010364536454010364556456010364576458010364596460010364616462010364636464010364656466010364676468010364696470010364716472010364736474010364756476010364776478010364796480010364816482010364836484010364856486010364876488010364896490010364916492010364936494010364956496010364976498010364996500010365016502010365036504010365056506010365076508010365096510010365116512010365136514010365156516010365176518010365196520010365216522010365236524010365256526010365276528010365296530010365316532010365336534010365356536010365376538010365396540010365416542010365436544010365456546010365476548010365496550010365516552010365536554010365556556010365576558010365596560010365616562010365636564010365656566010365676568010365696570010365716572010365736574010365756576010365776578010365796580010365816582010365836584010365856586010365876588010365896590010365916592010365936594010365956596010365976598010365996600010366016602010366036604010366056606010366076608010366096610010366116612010366136614010366156616010366176618010366196620010366216622010366236624010366256626010366276628010366296630010366316632010366336634010366356636010366376638010366396640010366416642010366436644010366456646010366476648010366496650010366516652010366536654010366556656010366576658010366596660010366616662010366636664010366656666010366676668010366696670010366716672010366736674010366756676010366776678010366796680010366816682010366836684010366856686010366876688010366896690010366916692010366936694010366956696010366976698010366996700010367016702010367036704010367056706010367076708010367096710010367116712010367136714010367156716010367176718010367196720010367216722010367236724010367256726010367276728010367296730010367316732010367336734010367356736010367376738010367396740010367416742010367436744010367456746010367476748010367496750010367516752010367536754010367556756010367576758010367596760010367616762010367636764010367656766010367676768010367696770010367716772010367736774010367756776010367776778010367796780010367816782010367836784010367856786010367876788010367896790010367916792010367936794010367956796010367976798010367996800010368016802010368036804010368056806010368076808010368096810010368116812010368136814010368156816010368176818010368196820010368216822010368236824010368256826010368276828010368296830010368316832010368336834010368356836010368376838010368396840010368416842010368436844010368456846010368476848010368496850010368516852010368536854010368556856010368576858010368596860010368616862010368636864010368656866010368676868010368696870010368716872010368736874010368756876010368776878010368796880010368816882010368836884010368856886010368876888010368896890010368916892010368936894010368956896010368976898010368996900010369016902010369036904010369056906010369076908010369096910010369116912010369136914010369156916010369176918010369196920010369216922010369236924010369256926010369276928010369296930010369316932010369336934010369356936010369376938010369396940010369416942010369436944010369456946010369476948010369496950010369516952010369536954010369556956010369576958010369596960010369616962010369636964010369656966010369676968010369696970010369716972010369736974010369756976010369776978010369796980010369816982010369836984010369856986010369876988010369896990010369916992010369936994010369956996010369976998010369996000010390016002010390036004010390056006010390076008010390096010010390116012010390136014010390156016010390176018010390196020010390216022010390236024010390256026010390276028010390296030010390316032010390336034010390356036010390376038010390396040010390416042010390436044010390456046010390476048010390496050010390516052010390536054010390556056010390576058010390596060010390616062010390636064010390656066010390676068010390696070010390716072010390736074010390756076010390776078010390796080010390816082010390836084010390856086010390876088010390896090010390916092010390936094010390956096010390976098010390996100010391016102010391036104010391056106010391076108010391096110010391116112010391136114010391156116010391176118010391196120010391216122010391236124010391256126010391276128010391296130010391316132010391336134010391356136010391376138010391396140010391416142010391436144010391456146010391476148010391496150010391516152010391536154010391556156010391576158010391596160010391616162010391636164010391656166010391676168010391696170010391716172010391736174010391756176010391776178010391796180010391816182010391836184010391856186010391876188010391896190010391916192010391936194010391956196010391976198010391996200010392016202010392036204010392056206010392076208010392096210010392116212010392136214010392156216010392176218010392196220010392216222010392236224010392256226010392276228010392296230010392316232010392336234010392356236010392376238010392396240010392416242010392436244010392456246010392476248010392496250010392516252010392536254010392556256010392576258010392596260010392616262010392636264010392656266010392676268010392696270010392716272010392736274010392756276010392776278010392796280010392816282010392836284010392856286010392876288010392896290010392916292010392936294010392956296010392976298010392996300010393016302010393036304010393056306010393076308010393096310010393116312010393136314010393156316010393176318010393196320010393216322010393236324010393256326010393276328010393296330010393316332010393336334010393356336010393376338010393396340010393416342010393436344010393456346010393476348010393496350010393516352010393536354010393556356010393576358010393596360010393616362010393636364010393656366010393676368010393696370010393716372010393736374010393756376010393776378010393796380010393816382010393836384010393856386010393876388010393896390010393916392010393936394010393956396010393976398010393996400010394016402010394036404010394056406010394076408010394096410010394116412010394136414010394156416010394176418010394196420010394216422010394236424010394256426010394276428010394296430010394316432010394336434010394356436010394376438010394396440010394416442010394436444010394456446010394476448010394496450010394516452010394536454010394556456010394576458010394596460010394616462010394636464010394656466010394676468010394696470010394716472010394736474010394756476010394776478010394796480010394816482010394836484010394856486010394876488010394896490010394916492010394936494010394956496010394976498010394996500010395016502010395036504010395056506010395076508010395096510010395116512010395136514010395156516010395176518010395196520010395216522010395236524010395256526010395276528010395296530010395316532010395336534010395356536010395376538010395396540010395416542010395436544010395456546010395476548010395496550010395516552010395536554010395556556010395576558010395596560010395616562010395636564010395656566010395676568010395696570010395716572010395736574010395756576010395776578010395796580010395816582010395836584010395856586010395876588010395896590010395916592010395936594010395956596010395976598010395996600010396016602010396036604010396056606010396076608010396096610010396116612010396136614010396156616010396176618010396196620010396216622010396236624010396256626010396276628010396296630010396316632010396336634010396356636010396376638010396396640010396416642010396436644010396456646010396476648010396496650010396516652010396536654010396556656010396576658010396596660010396616662010396636664010396656666010396676668010396696670010396716672010396736674010396756676010396776678010396796680010396816682010396836684010396856686010396876688010396896690010396916692010396936694010396956696010396976698010396996700010397016702010397036704010397056706010397076708010397096710010397116712010397136714010397156716010397176718010397196720010397216722010397236724010397256726010397276728010397296730010397316732010397336734010397356736010397376738010397396740010397416742010397436744010397456746010397476748010397496750010397516752010397536754010397556756010397576758010397596760010397616762010397636764010397656766010397676768010397696770010397716772010397736774010397756776010397776778010397796780010397816782010397836784010397856786010397876788010397896790010397916792010397936794010397956796010397976798010397996800010398016802010398036804010398056806010398076808010398096810010398116812010398136814010398156816010398176818010398196820010398216822010398236824010398256826010398276828010398296830010398316832010398336834010398356836010398376838010398396840010398416842010398436844010398456846010398476848010398496850010398516852010398536854010398556856010398576858010398596860010398616862010398636864010398656866010398676868010398696870010398716872010398736874010398756876010398776878010398796880010398816882010398836884010398856886010398876888010398896890010398916892010398936894010398956896010398976898010398996900010399016902010399036904010399056906010399076908010399096910010399116912010399136914010399156916010399176918010399196920010399216922010399236924010399256926010399276928010399296930010399316932010399336934010399356936010399376938010399396940010399416942010399436944010399456946010399476948010399496950010399516952010399536954010399556956010399576958010399596960010399616962010399636964010399656966010399676968010399696970010399716972010399736974010399756976010399776978010399796980010399816982010399836984010399856986010399876988010399896990010399916992010399936994010399956996010399976998010399996000010600016002010600036004010600056006010600076008010600096010010600116012010600136014010600156016010600176018010600196020010600216022010600236024010600256026010600276028010600296030010600316032010600336034010600356036010600376038010600396040010600416042010600436044010600456046010600476048010600496050010600516052010600536054010600556056010600576058010600596060010600616062010600636064010600656066010600676068010600696070010600716072010600736074010600756076010600776078010600796080010600816082010600836084010600856086010600876088010600896090010600916092010600936094010600956096010600976098010600996100010601016102010601036104010601056106010601076108010601096110010601116112010601136114010601156116010601176118010601196120010601216122010601236124010601256126010601276128010601296130010601316132010601336134010601356136010601376138010601396140010601416142010601436144010601456146010601476148010601496150010601516152010601536154010601556156010601576158010601596160010601616162010601636164010601656166010601676168010601696170010601716172010601736174010601756176010601776178010601796180010601816182010601836184010601856186010601876188010601896190010601916192010601936194010601956196010601976198010601996200010602016202010602036204010602056206010602076208010602096210010602116212010602136214010602156216010602176218010602196220010602216222010602236224010602256226010602276228010602296230010602316232010602336234010602356236010602376238010602396240010602416242010602436244010602456246010602476248010602496250010602516252010602536254010602556256010602576258010602596260010602616262010602636264010602656266010602676268010602696270010602716272010602736274010602756276010602776278010602796280010602816282010602836284010602856286010602876288010602896290010602916292010602936294010602956296010602976298010602996300010603016302010603036304010603056306010603076308010603096310010603116312010603136314010603156316010603176318010603196320010603216322010603236324010603256326010603276328010603296330010603316332010603336334010603356336010603376338010603396340010603416342010603436344010603456346010603476348010603496350010603516352010603536354010603556356010603576358010603596360010603616362010603636364010603656366010603676368010603696370010603716372010603736374010603756376010603776378010603796380010603816382010603836384010603856386010603876388010603896390010603916392010603936394010603956396010603976398010603996400010604016402010604036404010604056406010604076408010604096410010604116412010604136414010604156416010604176418010604196420010604216422010604236424010604256426010604276428010604296430010604316432010604336434010604356436010604376438010604396440010604416442010604436444010604456446010604476448010604496450010604516452010604536454010604556456010604576458010604596460010604616462010604636464010604656466010604676468010604696470010604716472010604736474010604756476010604776478010604796480010604816482010604836484010604856486010604876488010604896490010604916492010604936494010604956496010604976498010604996500010605016502010605036504010605056506010605076508010605096510010605116512010605136514010605156516010605176518010605196520010605216522010605236524010605256526010605276528010605296530010605316532010605336534010605356536010605376538010605396540010605416542010605436544010605456546010605476548010605496550010605516552010605536554010605556556010605576558010605596560010605616562010605636564010605656566010605676568010605696570010605716572010605736574010605756576010605776578010605796580010605816582010605836584010605856586010605876588010605896590010605916592010605936594010605956596010605976598010605996600010606016602010606036604010606056606010606076608010606096610010606116612010606136614010606156616010606176618010606196620010606216622010606236624010606256626010606276628010606296630010606316632010606336634010606356636010606376638010606396640010606416642010606436644010606456646010606476648010606496650010606516652010606536654010606556656010606576658010606596660010606616662010606636664010606656666010606676668010606696670010606716672010606736674010606756676010606776678010606796680010606816682010606836684010606856686010606876688010606896690010606916692010606936694010606956696010606976698010606996700010607016702010607036704010607056706010607076708010607096710010607116712010607136714010607156716010607176718010607196720010607216722010607236724010607256726010607276728010607296730010607316732010607336734010607356736010607376738010607396740010607416742010607436744010607456746010607476748010607496750010607516752010607536754010607556756010607576758010607596760010607616762010607636764010607656766010607676768010607696770010607716772010607736774010607756776010607776778010607796780010607816782010607836784010607856786010607876788010607896790010607916792010607936794010607956796010607976798010607996800010608016802010608036804010608056806010608076808010608096810010608116812010608136814010608156816010608176818010608196820010608216822010608236824010608256826010608276828010608296830010608316832010608336834010608356836010608376838010608396840010608416842010608436844010608456846010608476848010608496850010608516852010608536854010608556856010608576858010608596860010608616862010608636864010608656866010608676868010608696870010608716872010608736874010608756876010608776878010608796880010608816882010608836884010608856886010608876888010608896890010608916892010608936894010608956896010608976898010608996900010609016902010609036904010609056906010609076908010609096910010609116912010609136914010609156916010609176918010609196920010609216922010609236924010609256926010609276928010609296930010609316932010609336934010609356936010609376938010609396940010609416942010609436944010609456946010609476948010609496950010609516952010609536954010609556956010609576958010609596960010609616962010609636964010609656966010609676968010609696970010609716972010609736974010609756976010609776978010609796980010609816982010609836984010609856986010609876988010609896990010609916992010609936994010609956996010609976998010609996000010010016002010010036004010010056006010010076008010010096010010010116012010010136014010010156016010010176018010010196020010010216022010010236024010010256026010010276028010010296030010010316032010010336034010010356036010010376038010010396040010010416042010010436044010010456046010010476048010010496050010010516052010010536054010010556056010010576058010010596060010010616062010010636064010010656066010010676068010010696070010010716072010010736074010010756076010010776078010010796080010010816082010010836084010010856086010010876088010010896090010010916092010010936094010010956096010010976098010010996100010"
        
        # These should have different importance scores
        result1 = engine.multi_dimensional_compare(storage_heavy[:200], storage_heavy[200:400])
        result2 = engine.multi_dimensional_compare(arithmetic_heavy[:200], arithmetic_heavy[200:400])
        
        # Both should be valid results
        assert 0.0 <= result1['overall_similarity'] <= 1.0
        assert 0.0 <= result2['overall_similarity'] <= 1.0
    
    def test_performance_with_large_bytecode(self, engine):
        """Test performance with large bytecode inputs."""
        import time
        
        # Create large bytecode samples
        large_bytecode1 = "608060405234801561001057600080fd5b50" * 100
        large_bytecode2 = "608060405234801561001057600080fd5b51" * 100
        
        start_time = time.time()
        result = engine.multi_dimensional_compare(large_bytecode1, large_bytecode2)
        end_time = time.time()
        
        processing_time = end_time - start_time
        
        # Should complete within reasonable time
        assert processing_time < 10.0  # Less than 10 seconds
        assert isinstance(result, dict)
        assert 0.0 <= result['overall_similarity'] <= 1.0


class TestComparisonEngineEdgeCases:
    """Test edge cases and error conditions."""
    
    def test_invalid_input_handling(self):
        """Test handling of invalid inputs."""
        engine = BytecodeComparisonEngine({})
        
        invalid_inputs = [
            (None, "60016002"),
            ("60016002", None),
            ("invalid_hex", "60016002"),
            ("60016002", "invalid_hex"),
            ("", "60016002"),  # Empty string
            ("60016002", ""),  # Empty string
        ]
        
        for bytecode1, bytecode2 in invalid_inputs:
            try:
                result = engine.multi_dimensional_compare(bytecode1, bytecode2)
                # Should handle gracefully
                assert isinstance(result, dict)
                assert 'overall_similarity' in result
                assert 0.0 <= result['overall_similarity'] <= 1.0
            except (ValueError, TypeError, AttributeError):
                # Expected for some invalid inputs
                pass


if __name__ == "__main__":
    pytest.main([__file__, "-v"])

#!/bin/bash
# Execute exploit contract

set -e

echo "Executing exploit..."

if [ ! -f "/tmp/contract_address.txt" ]; then
    echo "No contract address found. Deploy contract first."
    exit 1
fi

CONTRACT_ADDRESS=$(cat /tmp/contract_address.txt)
echo "Target contract address: $CONTRACT_ADDRESS"

# Check if exploit contract was compiled
if [ -f "/tmp/compiled/exploit.bin" ]; then
    echo "Deploying exploit contract..."
    
    EXPLOIT_BYTECODE=$(cat "/tmp/compiled/exploit.bin")
    EXPLOIT_TX=$(cast send \
        --rpc-url http://localhost:8545 \
        --private-key 0x4f3edf983ac636a65a842ce7c78d9aa706d3b113bce9c46f30d7d21715b23b1d \
        --create \
        "0x$EXPLOIT_BYTECODE" \
        --json)
    
    EXPLOIT_ADDRESS=$(echo "$EXPLOIT_TX" | jq -r '.contractAddress')
    echo "Exploit contract deployed at: $EXPLOIT_ADDRESS"
    
    # Try to execute exploit
    echo "Attempting to execute exploit..."
    
    # Call exploit function (assuming it's named 'exploit')
    EXPLOIT_RESULT=$(cast send \
        --rpc-url http://localhost:8545 \
        --private-key 0x4f3edf983ac636a65a842ce7c78d9aa706d3b113bce9c46f30d7d21715b23b1d \
        "$EXPLOIT_ADDRESS" \
        "exploit()" \
        --json)
    
    echo "Exploit execution result:"
    echo "$EXPLOIT_RESULT" | jq .
    
    # Check gas usage
    GAS_USED=$(echo "$EXPLOIT_RESULT" | jq -r '.gasUsed')
    echo "Gas used: $GAS_USED"
    
    # Check for any events or state changes
    echo "Checking exploit impact..."
    
    # Get final balances
    ATTACKER_BALANCE=$(cast balance \
        --rpc-url http://localhost:8545 \
        0x90F8bf6A479f320ead074411a4B0e7944Ea8c9C1)
    
    echo "Attacker balance after exploit: $ATTACKER_BALANCE"
    
    # Check if exploit was successful based on output
    if echo "$EXPLOIT_RESULT" | grep -q "success.*true"; then
        echo "Exploit successful!"
        echo "Reentrancy successful"
    else
        echo "Exploit may have failed"
    fi
    
else
    echo "No exploit bytecode found. Compilation may have failed."
    exit 1
fi
